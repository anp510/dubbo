name: Fixed Build And Test Scheduled

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: read

env:
  FORK_COUNT: 2
  FAIL_FAST: 0
  SHOW_ERROR_DETAIL: 1
  #multi-version size limit
  VERSIONS_LIMIT: 4
  JACOCO_ENABLE: true
  CANDIDATE_VERSIONS: '
    spring.version:5.3.24;
    spring-boot.version:2.7.6;
    '

jobs:
  build-source:
    name: "Build Dubbo"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.dubbo-version.outputs.version }}
    steps:
      - uses: actions/checkout@v3
        with:
          path: dubbo
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: 8
      - uses: actions/cache@v3
        name: "Cache local Maven repository"
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
            ${{ runner.os }}-maven-
      - name: "Dubbo cache"
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository/org/apache/dubbo
          key: ${{ runner.os }}-dubbo-snapshot-${{ github.sha }}-${{ github.run_id }}
      - name: "Build Dubbo with Maven"
        run: |
          cd ./dubbo
          ./mvnw --batch-mode --no-snapshot-updates -e --no-transfer-progress --fail-fast clean source:jar install -Pjacoco,checkstyle -Dmaven.wagon.httpconnectionManager.ttlSeconds=120 -Dmaven.wagon.http.retryHandler.count=5 -Dmaven.test.skip=true -Dmaven.test.skip.exec=true -DembeddedZookeeperPath=${{ github.workspace }}/.tmp/zookeeper
      - name: "Calculate Dubbo Version"
        id: dubbo-version
        run: |
          REVISION=`awk '/<revision>[^<]+<\/revision>/{gsub(/<revision>|<\/revision>/,"",$1);print $1;exit;}' ./dubbo/pom.xml`
          echo "version=$REVISION" >> $GITHUB_OUTPUT
          echo "dubbo version: $REVISION"
  samples-test-prepare:
    runs-on: ubuntu-latest
    env:
      JOB_COUNT: 3
    steps:
      - uses: actions/checkout@v3
        with:
          repository: 'wxbty/dubbo-samples'
          ref: bh-bak
      - name: "Prepare test list"
        run: |
          bash ./test/scripts/prepare-test.sh
      - name: "Upload test list"
        uses: actions/upload-artifact@v3
        with:
          name: samples-test-list
          path: test/jobs
  samples-test-job:
    needs: [build-source, samples-test-prepare]
    name: "Samples Test on ubuntu-latest (JobId: ${{matrix.job_id}})"
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      JAVA_VER: 8
      TEST_CASE_FILE: jobs/testjob_${{matrix.job_id}}.txt
    strategy:
      fail-fast: false
      matrix:
        job_id: [1, 2, 3]
    steps:
      - uses: actions/checkout@v3
        with:
          repository: 'wxbty/dubbo-samples'
          ref: bh-bak
      - name: "Cache local Maven repository"
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
            ${{ runner.os }}-maven-
      - name: "Restore Dubbo cache"
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository/org/apache/dubbo
          key: ${{ runner.os }}-dubbo-snapshot-${{ github.sha }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-dubbo-snapshot-${{ github.sha }}
            ${{ runner.os }}-dubbo-snapshot-
      - name: "Download test list"
        uses: actions/download-artifact@v3
        with:
          name: samples-test-list
          path: test/jobs/
      - name: "Set up JDK 8"
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: 8
      - name: "Init Candidate Versions"
        run: |
          DUBBO_VERSION="${{needs.build-source.outputs.version}}"
          CANDIDATE_VERSIONS="dubbo.version:$DUBBO_VERSION;compiler.version:$DUBBO_VERSION;$CANDIDATE_VERSIONS;dubbo.compiler.version:$DUBBO_VERSION"
          echo "CANDIDATE_VERSIONS=$CANDIDATE_VERSIONS" >> $GITHUB_ENV
      - name: "Replace runtime parameter rpc:dubbo tri rmi"
        run: |
          RUNTIME_CONFIG_PATH=./10-task/dubbo-samples-benchmark/case-runtime-parameter.conf
          rm -rf $RUNTIME_CONFIG_PATH
      - name: "Build test image"
        run: |
          cd test && bash ./build-test-image.sh
      - name: "Run tests"
        run: cd test && bash ./run-tests.sh 10-task/dubbo-samples-benchmark/
      - name: "Upload test result"
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: samples-test-result
          path: test/jobs/*-result*
      - name: "Upload jmh output result"
        uses: actions/upload-artifact@v3
        with:
          name: samples-jmh-result
          path: /tmp/jmh*.json
      - name: "Upload Error Build Log"
        uses: actions/upload-artifact@v3
        with:
          name: samples-build-result
          path: /tmp/logs/*
      - name: Push results to results repository
        env:
          RESULTS_REPO_OWNER: wxbty
          RESULTS_REPO_NAME: jmh_result
          RESULTS_REPO_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN }}
        run: |
          if ! ls /tmp/jmh_result_prop*.json -1q &> /dev/null; then
            echo "No file matching /tmp/jmh_result_prop*.json exists. Exiting..."
            exit 0
          fi
          git clone https://github.com/${RESULTS_REPO_OWNER}/${RESULTS_REPO_NAME}.git jmh_result
          cd jmh_result
          git config user.email "dubbo@apache.org"
          git config user.name "dubbo"

          WORK_DIR="$(pwd)"
          echo "WorkDir: $WORK_DIR"
          DIRECTORY_PATH="$WORK_DIR/test-results/scenario"
          rm -rf $DIRECTORY_PATH/*
          cp /tmp/jmh_result_prop*.json "$DIRECTORY_PATH"

          if ls /tmp/jmh_trace*.json 1>/dev/null 2>&1; then
            TRACE_PATH="$WORK_DIR/test-results/trace"
            rm -rf $TRACE_PATH/*
            cp /tmp/jmh_trace*.json "$TRACE_PATH"
          fi

          sudo apt-get update
          sudo apt-get install -y jq

          merged_file="merged_prop_results.json"
          merged_json=$(jq -s 'add' "$DIRECTORY_PATH"/jmh_result_prop*.json)
          echo "$merged_json" > "$DIRECTORY_PATH/$merged_file"

          RESULT_PATH="$WORK_DIR/test-results"
          git add $RESULT_PATH
          git commit -m "Compare prop in $(date +'%Y-%m-%d %H:%M:%S')"
          git push https://${GITHUB_TOKEN}@github.com/${RESULTS_REPO_OWNER}/${RESULTS_REPO_NAME}.git ${RESULTS_REPO_BRANCH}

  samples-test-result:
    needs: [samples-test-job]
    if: always()
    runs-on: ubuntu-latest
    env:
      JAVA_VER: 8
    steps:
      - uses: actions/checkout@v3
        with:
          repository: 'wxbty/dubbo-samples'
          ref: bh-bak
      - name: "Download test result"
        uses: actions/download-artifact@v3
        with:
          name: samples-test-result
          path: test/jobs/
      - name: "Merge test result"
        run: ./test/scripts/merge-test-results.sh
